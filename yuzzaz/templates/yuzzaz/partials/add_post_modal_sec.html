{% load widget_tweaks %}

<div class="bg-dark rounded-lg border border-gray-800 overflow-hidden">
    <div class="p-4 border-b border-gray-800">
        <h3 class="font-bold text-lg text-center text-maroon">
            <i class="fas fa-plus-circle mr-2"></i>Ask your question
        </h3>
    </div>
<form method="post" enctype="multipart/form-data" class="p-4" action="{% url 'add_post' %}">
    {% csrf_token %}
    
    <!-- Title -->
    <div class="mb-3">
        <input type="text" name="title" 
               class="w-full bg-gray-800 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-maroon placeholder-gray-500"
               placeholder="Post title"
               value="{{ form.title.value|default_if_none:'' }}">
        {% if form.title.errors %}
            <div class="text-red-500 text-xs mt-1">{{ form.title.errors }}</div>
        {% endif %}
    </div>

    <!-- Content -->
    <div class="mb-3">
        <textarea name="content" rows="4"
               class="w-full bg-gray-800 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-maroon placeholder-gray-500"
               placeholder="What's on your mind?">{{ form.content.value|default_if_none:'' }}</textarea>
        {% if form.content.errors %}
            <div class="text-red-500 text-xs mt-1">{{ form.content.errors }}</div>
        {% endif %}
    </div>

    <!-- Attachment Buttons -->
    <div class="flex justify-end space-x-4 mb-4">
        <button type="button" onclick="toggleAttachment('image')" class="attachment-btn focus:outline-none focus:ring-2 focus:ring-maroon focus:ring-opacity-50 flex items-center justify-center w-10 h-10 rounded-lg transition-colors duration-200 bg-gray-800 hover:bg-gray-700 text-maroon">
            <i class="fas fa-image"></i>
        </button>
        <button type="button" onclick="toggleAttachment('video')" class="attachment-btn focus:outline-none focus:ring-2 focus:ring-maroon focus:ring-opacity-50 flex items-center justify-center w-10 h-10 rounded-lg transition-colors duration-200 bg-gray-800 hover:bg-gray-700 text-maroon">
            <i class="fas fa-video"></i>
        </button>
        <button type="button" onclick="toggleAttachment('docs')" class="attachment-btn focus:outline-none focus:ring-2 focus:ring-maroon focus:ring-opacity-50 flex items-center justify-center w-10 h-10 rounded-lg transition-colors duration-200 bg-gray-800 hover:bg-gray-700 text-maroon">
            <i class="fas fa-file-alt"></i>
        </button>
        <button type="button" onclick="toggleAttachment('link')" class="attachment-btn focus:outline-none focus:ring-2 focus:ring-maroon focus:ring-opacity-50 flex items-center justify-center w-10 h-10 rounded-lg transition-colors duration-200 bg-gray-800 hover:bg-gray-700 text-maroon">
            <i class="fas fa-link"></i>
        </button>
    </div>

    <!-- Image Upload -->
    <div id="image-attachment" class="mb-3 hidden">
        <div class="grid grid-cols-1 gap-3">
            <div>
                <label class="block">
                    <div class="text-xs text-gray-400 mb-1">Upload Image 1</div>
                    <div class="flex items-center gap-2 bg-gray-800 rounded-lg px-3 py-2 cursor-pointer hover:bg-gray-700 transition">
                        <i class="fas fa-image text-maroon"></i>
                        <span class="text-sm text-gray-300 truncate" id="image-filename">
                            {% if form.instance.image %} 
                                {{ form.instance.image.name|cut:"posts/" }}
                            {% else %}
                                No file selected
                            {% endif %}
                        </span>
                        <input type="file" name="image" accept="image/*" class="hidden" id="image-upload">
                    </div>
                    {% if form.image.errors %}
                        <div class="text-red-500 text-xs mt-1">{{ form.image.errors }}</div>
                    {% endif %}
                </label>
            </div>
            <div>
                <label class="block">
                    <div class="text-xs text-gray-400 mb-1">Upload Image 2 (Optional)</div>
                    <div class="flex items-center gap-2 bg-gray-800 rounded-lg px-3 py-2 cursor-pointer hover:bg-gray-700 transition">
                        <i class="fas fa-image text-maroon"></i>
                        <span class="text-sm text-gray-300 truncate" id="image2-filename">
                            {% if form.instance.image2 %} 
                                {{ form.instance.image2.name|cut:"posts/" }}
                            {% else %}
                                No file selected
                            {% endif %}
                        </span>
                        <input type="file" name="image2" accept="image/*" class="hidden" id="image2-upload">
                    </div>
                    {% if form.image2.errors %}
                        <div class="text-red-500 text-xs mt-1">{{ form.image2.errors }}</div>
                    {% endif %}
                </label>
            </div>
        </div>
    </div>

    <!-- Video Upload -->
    <div id="video-attachment" class="mb-3 hidden">
        <label class="block">
            <div class="text-xs text-gray-400 mb-1">Upload Video</div>
            <div class="flex items-center gap-2 bg-gray-800 rounded-lg px-3 py-2 cursor-pointer hover:bg-gray-700 transition">
                <i class="fas fa-video text-maroon"></i>
                <span class="text-sm text-gray-300 truncate" id="video-filename">
                    {% if form.instance.video %} 
                        {{ form.instance.video.name|cut:"posts/" }}
                    {% else %}
                        No file selected
                    {% endif %}
                </span>
                <input type="file" name="video" accept="video/*" class="hidden" id="video-upload">
            </div>
            {% if form.video.errors %}
                <div class="text-red-500 text-xs mt-1">{{ form.video.errors }}</div>
            {% endif %}
        </label>
    </div>

    <!-- Document Upload -->
    <div id="docs-attachment" class="mb-3 hidden">
        <label class="block">
            <div class="text-xs text-gray-400 mb-1">Upload Document</div>
            <div class="flex items-center gap-2 bg-gray-800 rounded-lg px-3 py-2 cursor-pointer hover:bg-gray-700 transition">
                <i class="fas fa-file-alt text-maroon"></i>
                <span class="text-sm text-gray-300 truncate" id="docs-filename">
                    {% if form.instance.docs %} 
                        {{ form.instance.docs.name|cut:"posts/" }}
                    {% else %}
                        No file selected
                    {% endif %}
                </span>
                <input type="file" name="docs" accept=".pdf,.doc,.docx,.ppt,.pptx" class="hidden" id="docs-upload">
            </div>
            {% if form.docs.errors %}
                <div class="text-red-500 text-xs mt-1">{{ form.docs.errors }}</div>
            {% endif %}
        </label>
    </div>

    <!-- Link Field -->
    <div id="link-attachment" class="mb-3 hidden">
        <div class="text-xs text-gray-400 mb-1">Attach a link</div>
        <input type="url" name="link" placeholder="https://example.com"
               class="w-full bg-gray-800 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-maroon placeholder-gray-500"
               value="{{ form.link.value|default_if_none:'' }}">
        {% if form.link.errors %}
            <div class="text-red-500 text-xs mt-1">{{ form.link.errors }}</div>
        {% endif %}
    </div>

    <!-- Tag Selector -->
    <div class="mb-3">
    <select name="tag"
           class="w-full bg-gray-800 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-maroon">
        <option value="">Select a tag</option>
        {% for key, label in tag_choices %}
            {% if key %}
                <option value="{{ key }}">{{ label }}</option>
            {% endif %}
        {% endfor %}
    </select>
</div>
    <!-- Submit Button -->
    <button type="submit" class="w-full bg-maroon hover:bg-maroon-dark text-white py-2 px-4 rounded-lg font-medium transition">
        <i class="fas fa-paper-plane mr-2"></i> Ask
    </button>
</form>
</div>

<script>
    function toggleAttachment(type) {
        const attachmentTypes = ['image', 'video', 'docs', 'link'];

        attachmentTypes.forEach(t => {
            const section = document.getElementById(`${t}-attachment`);
            const hasValue =
                (t === 'image' && (document.getElementById('image-upload').files.length > 0 || document.getElementById('image2-upload').files.length > 0)) ||
                (t === 'video' && document.getElementById('video-upload').files.length > 0) ||
                (t === 'docs' && document.getElementById('docs-upload').files.length > 0) ||
                (t === 'link' && document.querySelector('input[name="link"]').value.trim() !== '');

            // Only hide if it doesn't have a value AND it's not the selected type
            if (!hasValue && t !== type) {
                section.classList.add('hidden');
            } else {
                section.classList.remove('hidden');
            }
        });
    }

    // When page loads, check if any inputs are pre-filled and show the relevant section(s)
    document.addEventListener('DOMContentLoaded', function () {
        toggleAttachment(null); // null forces the function to evaluate all and show any non-empty
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const fileInputs = [
            { inputId: "image-upload", labelId: "image-filename" },
            { inputId: "image2-upload", labelId: "image2-filename" },
            { inputId: "video-upload", labelId: "video-filename" },
            { inputId: "docs-upload", labelId: "docs-filename" },
        ];

        fileInputs.forEach(({ inputId, labelId }) => {
            const input = document.getElementById(inputId);
            const label = document.getElementById(labelId);

            if (input && label) {
                input.addEventListener("change", function () {
                    const file = input.files[0];
                    label.textContent = file ? file.name : "No file selected";
                });
            }
        });
    });
</script>
